#!/usr/bin/env bash
#
# init.d script for puma.

set -e
set -x

sig () {
  test -s "$PID" && kill -$1 `cat "$PID"`
}
 
oldsig () {
  test -s "$OLD_PID" && kill -$1 `cat "$OLD_PID"`
}
 
cmd () {
 
  case $1 in
    start)
      echo "Starting"
      start_server
      ;;  
    stop)
      stop_server
      echo >&2 "Not running"
      ;;  
    restart)
      stop_server
      sleep 5
      start_server
      ;;
    *)  
      echo >&2 "Usage: $0 <start|stop|restart|upgrade|rotate|force-stop>"
      exit 1
      ;;  
    esac
}

start_server () {
  if start-stop-daemon --start --chuid vagrant --exec "/usr/local/bin/bundle" --  exec /usr/local/bin/pumactl --config-file $SCRIPT_PATH/config/puma_vm.rb start 
  then
    echo "Startup Complete"
  else
    exit 1
  fi
}

stop_server () {
  if start-stop-daemon --stop --pidfile /var/run/puma/search_services.pid
  then
    rm -f /var/run/puma/*
    echo "Process killed"
  else
    echo "Nothing killed, server may not have been running"
  fi
}

setup () {
  SCRIPT_PATH='/opt/search_services'
  export RACK_ENV=`cat $SCRIPT_PATH/config/environment`
  export BUNDLE_GEMFILE=$SCRIPT_PATH/Gemfile
  cd $SCRIPT_PATH
  sudo -u vagrant bundle install
}

setup $1
cmd $1
