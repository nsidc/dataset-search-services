# Puppet CI Resources

classes:
  - nsidc_jenkins
  - nsidc_nfs

# NFS Mounts
nsidc_nfs::sharemounts:
  /share/sw/packages:
    project: sw
    share: packages

# Jenkins Plugins
nsidc_jenkins::plugins:
  git: {}
  git-client: {}
  git-parameter: {}
  scm-api: {}
  credentials: {}
  ssh-credentials: {}
  greenballs: {}
  jobConfigHistory: {}
  mailer: {}
  instant-messaging: {}
  jabber: {}

# Jenkins Jobs
nsidc_jenkins::jobs:
  # clone the project into the shared workspace
  "%{hiera('project')}_01_Checkout_Project":
    gitrepo: %{hiera('gitrepo')}
    workspace: /var/lib/jenkins/workspace
    trigger_job: "%{hiera('project')}_02_Configure_System"

  # use puppet to install system dependencies, such as Bundler
  "%{hiera('project')}_02_Configure_System":
    command: |
      cd puppet
      librarian-puppet clean
      librarian-puppet update
      cd -
      sudo puppet apply --environment=ci --debug --verbose --modulepath=./puppet/modules --hiera_config=./puppet/hiera.yaml ./puppet/site.pp

      # Because running `puppet apply` modifies the config.xml for each job
      # defined in ci.yaml, Jenkins has trouble triggering the next job through
      # normal methods (ie, using the trigger_job param), but we can use the
      # Jenkins API to trigger the next job with curl. Just make sure the name
      # of the job in the curl command is correct:
      sleep 15
      echo "Triggering a new build of %{hiera('project')}_03_Install_Dependencies"
      curl localhost:8080/job/%{hiera('project')}_03_Install_Dependencies
    workspace: /var/lib/jenkins/workspace

  "%{hiera('project')}_03_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspace
    trigger_job: "%{hiera('project')}_04_Check_Syntax"

  "%{hiera('project')}_04_Check_Syntax":
    command: bundle exec rubocop
    workspace: /var/lib/jenkins/workspace
    trigger_job: "%{hiera('project')}_05_Run_Unit_Tests"

  "%{hiera('project')}_05_Run_Unit_Tests":
    command: bundle exec rake spec:unit
    workspace: /var/lib/jenkins/workspace
    trigger_job: "%{hiera('project')}_06_Provision_Integration"

  "%{hiera('project')}_06_Provision_Integration":
    command: |
      ENV=integration

      (vagrant nsidc hijack --env=$ENV || true)
      vagrant nsidc up --env=$ENV
      vagrant nsidc ssh --env=$ENV -c 'sudo mkdir -p /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo cp -R /vagrant/* /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo chown -R vagrant /opt/search_services'
      bundle exec rake start_puma[$ENV]
    workspace: /var/lib/jenkins/workspace
    trigger_job: "%{hiera('project')}_07_Run_Integration_Tests"

  "%{hiera('project')}_07_Run_Integration_Tests":
    command: |
      export TARGET_ENVIRONMENT=integration
      bundle exec rake spec:acceptance
    workspace: /var/lib/jenkins/workspace

  "%{hiera('project')}_08_QA_Checkout_Project":
    parameters:
      - type: string
        name: tag
        description: git tag to checkout
        default: v1.0.0
    command: |
      (git clone %{hiera('gitrepo')} . || true)
      git checkout $tag

      # temp, rm below this
      git fetch origin ci-ize-it
      git checkout ci-ize-it
    workspace: /var/lib/jenkins/workspace-qa
    trigger_job: "%{hiera('project')}_09_QA_Install_Dependencies"

  "%{hiera('project')}_09_QA_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspace-qa
    trigger_job: "%{hiera('project')}_10_QA_Check_Syntax"

  "%{hiera('project')}_10_QA_Check_Syntax":
    command: bundle exec rubocop
    workspace: /var/lib/jenkins/workspace-qa
    trigger_job: "%{hiera('project')}_11_QA_Run_Unit_Tests"

  "%{hiera('project')}_11_QA_Run_Unit_Tests":
    command: bundle exec rake spec:unit
    workspace: /var/lib/jenkins/workspace-qa
    trigger_job: "%{hiera('project')}_12_QA_Provision"

  "%{hiera('project')}_12_QA_Provision":
    command: |
      ENV=qa

      (vagrant nsidc hijack --env=$ENV || true)
      vagrant nsidc up --env=$ENV
      vagrant nsidc ssh --env=$ENV -c 'sudo mkdir -p /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo cp -R /vagrant/* /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo chown -R vagrant /opt/search_services'
      bundle exec rake start_puma[$ENV]
    workspace: /var/lib/jenkins/workspace-qa
    trigger_job: "%{hiera('project')}_13_QA_Run_Integration_Tests"

  "%{hiera('project')}_13_QA_Run_Integration_Tests":
    command: |
      export TARGET_ENVIRONMENT=qa
      bundle exec rake spec:acceptance
    workspace: /var/lib/jenkins/workspace-qa

  "%{hiera('project')}_14_Staging_Checkout_Project":
    parameters:
      - type: string
        name: tag
        description: git tag to checkout
        default: v1.0.0
    command: |
      (git clone %{hiera('gitrepo')} . || true)
      git checkout $tag

      # temp, rm below this
      git fetch origin ci-ize-it
      git checkout ci-ize-it
    workspace: /var/lib/jenkins/workspace-staging
    trigger_job: "%{hiera('project')}_15_Staging_Install_Dependencies"

  "%{hiera('project')}_15_Staging_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspace-staging
    trigger_job: "%{hiera('project')}_16_Staging_Check_Syntax"

  "%{hiera('project')}_16_Staging_Check_Syntax":
    command: bundle exec rubocop
    workspace: /var/lib/jenkins/workspace-staging
    trigger_job: "%{hiera('project')}_17_Staging_Run_Unit_Tests"

  "%{hiera('project')}_17_Staging_Run_Unit_Tests":
    command: bundle exec rake spec:unit
    workspace: /var/lib/jenkins/workspace-staging
    trigger_job: "%{hiera('project')}_18_Staging_Provision"

  "%{hiera('project')}_18_Staging_Provision":
    command: |
      ENV=staging

      (vagrant nsidc hijack --env=$ENV || true)
      vagrant nsidc up --env=$ENV
      vagrant nsidc ssh --env=$ENV -c 'sudo mkdir -p /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo cp -R /vagrant/* /opt/search_services'
      vagrant nsidc ssh --env=$ENV -c 'sudo chown -R vagrant /opt/search_services'
      bundle exec rake start_puma[$ENV]
    workspace: /var/lib/jenkins/workspace-staging
    trigger_job: "%{hiera('project')}_19_Staging_Run_Integration_Tests"

  "%{hiera('project')}_19_Staging_Run_Integration_Tests":
    command: |
      export TARGET_ENVIRONMENT=staging
      bundle exec rake spec:acceptance
    workspace: /var/lib/jenkins/workspace-staging

  "%{hiera('project')}_20_Blue_Provision":
    parameters:
      - type: string
        name: tag
        description: git tag to checkout and deploy
        default: v1.0.0
    command: |
      ENV=blue

      (git clone %{hiera('gitrepo')} . || true)
      git checkout $tag

      bundle install

      vagrant nsidc up --env=$ENV
      bundle exec rake start_puma[$ENV]
    workspace: /var/lib/jenkins/workspace-blue


  "%{hiera('project')}_Release_01_Bump_Version":
    parameters:
      - type: string
        name: branch
        description: git branch to checkout and tag
        default: v1.0.0
      - type: choice
        name: version_type
        choices:
        - patch
        - minor
        - major
    command: |
      (git clone %{hiera('gitrepo')} . || true)
      git checkout refs/heads/$branch

      bundle install
      bundle exec rake jenkins:release:bump[$version_part]
    workspace: /var/lib/jenkins/workspace-release
    trigger_job: "%{hiera('project')}_Release_02_Push_to_Git"

  "%{hiera('project')}_Release_02_Push_to_Git":
    command: bundle exec rake jenkins:release:push
    workspace: /var/lib/jenkins/workspace-release
